<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pay Boss Entertainment Manager</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  
  <style>
    body {
      box-sizing: border-box;
    }
    
    /* Animasi standar untuk room aktif */
    @keyframes pulse-glow-blue {
      0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); } /* Biru */
      50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.8); }
    }
    
    /* Animasi BARU untuk room yang waktunya habis */
    @keyframes pulse-glow-red {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); /* Merah */
        border-color: rgba(239, 68, 68, 0.8);
      }
      50% { 
        box-shadow: 0 0 35px rgba(239, 68, 68, 1); /* Merah Terang */
        border-color: rgba(239, 68, 68, 1);
      }
    }
    
    .active-room {
      animation: pulse-glow-blue 2s infinite; /* Menggunakan animasi biru */
      border: 2px solid transparent;
    }

    /* Class BARU untuk notifikasi waktu habis */
    .expired-room {
      animation: pulse-glow-red 1s infinite; /* Menggunakan animasi merah, lebih cepat */
      border: 2px solid #EF4444; /* Border merah */
    }
    
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    
    /* CSS Print bawaan browser tetap disimpan sebagai cadangan */
    @media print {
      body * { visibility: hidden; }
      #receipt-print, #receipt-print * { visibility: visible; }
      #receipt-print { position: absolute; left: 0; top: 0; width: 80mm; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
</head>
<body class="min-h-full bg-gray-100">
  <div id="app" class="min-h-full"></div>

  <script>
    (function() {
      let mockConfig = null;
      let globalConfigChangeHandler = null;

      window.elementSdk = {
        config: {}, 
        init: (options) => {
          console.log("Mock Element SDK Initialized");
          mockConfig = options.defaultConfig || {};
          window.elementSdk.config = mockConfig;
          globalConfigChangeHandler = options.onConfigChange;
          
          if (globalConfigChangeHandler) {
            setTimeout(() => globalConfigChangeHandler(mockConfig), 0);
          }
          
          return {
            mapToCapabilities: options.mapToCapabilities || (() => ({})),
            mapToEditPanelValues: options.mapToEditPanelValues || (() => new Map())
          };
        },
        setConfig: (newConfig) => {
          mockConfig = Object.assign(window.elementSdk.config, newConfig);
          if (globalConfigChangeHandler) {
            globalConfigChangeHandler(mockConfig);
          }
        }
      };
    })();
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const defaultConfig = {
      app_title: "One Stop Entertainment Pay Boss",
      billiard_enabled: "false", 
      karaoke_enabled: "true",
      massage_enabled: "false", 
      billiard_price: "50000",
      billiard_service: "0",
      massage_price: "30000",
      massage_service: "0",
      karaoke_k1_price: "175000", 
      karaoke_k1_service: "15000",
      karaoke_k2_price: "100000", 
      karaoke_k2_service: "10000",
      karaoke_k3_price: "100000", 
      karaoke_k3_service: "10000",
      background_color: "#F3F4F6", 
      surface_color: "#FFFFFF",    
      text_color: "#1F2937",       
      primary_action_color: "#3B82F6", 
      secondary_action_color: "#6B7280", 
      font_family: "Inter",
      font_size: 16
    };
    
    let db, auth, app, userId, appId;
    let unsubscribeBookings = null; 
    let roomTimerInterval = null; 
    let audioCtx = null; 
    let playedSounds = {}; 

    let currentUser = null; 
    let allBookings = []; 
    let currentView = 'login';
    let selectedBooking = null;

    const USERS = {
      kasir1: { username: 'kasir1', password: 'kasir123', role: 'Kasir', name: 'Kasir 1' },
      kasir2: { username: 'kasir2', password: 'kasir123', role: 'Kasir', name: 'Kasir 2' },
      manager: { username: 'manager', password: 'manager123', role: 'Manager', name: 'Manager' }
    };

    const ROOMS = {
      billiard: [{ id: 'B1', name: 'Billiard 1', type: 'billiard' }],
      karaoke: [
        { id: 'K1', name: 'Karaoke 1 (Besar)', type: 'karaoke' }, 
        { id: 'K2', name: 'Karaoke 2', type: 'karaoke' },
        { id: 'K3', name: 'Karaoke 3', type: 'karaoke' }
      ],
      massage: [{ id: 'M1', name: 'KursI Pijat 1', type: 'massage' }]
    };

    const dataHandler = {
      onDataChanged(data) {
        allBookings = data;
        if (currentView !== 'login') {
          renderApp();
          updateRoomTimers(); 
        }
      }
    };

    async function initializeFirebaseAndAuth() {
      const firebaseConfig = {
        apiKey: "AIzaSyCom-U-BP75_6j_9dwCXdA0VD1vmfCopOg",
        authDomain: "paybossmanager.firebaseapp.com",
        projectId: "paybossmanager",
        storageBucket: "paybossmanager.firebasestorage.app",
        messagingSenderId: "627431696008",
        appId: "1:627431696008:web:56137065fbd9aee32b613d"
      };
      appId = firebaseConfig.projectId || 'default-app-id';

      if (!firebaseConfig.apiKey) {
        console.error("Firebase config missing!");
        return;
      }

      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      setLogLevel('Debug'); 

      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          loadBookings();
        } else {
          userId = null;
          if (unsubscribeBookings) {
            unsubscribeBookings(); 
            unsubscribeBookings = null;
          }
          stopRoomTimer(); 
          renderApp(); 
        }
      });

      try {
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Firebase sign-in failed:", error);
      }
    }
    
    function loadBookings() {
      if (!userId) return; 
      
      if (unsubscribeBookings) {
        unsubscribeBookings();
      }

      const collectionRef = collection(db, 'payboss_bookings', appId, 'all_bookings');
      
      unsubscribeBookings = onSnapshot(collectionRef, (snapshot) => {
        const bookingsData = snapshot.docs.map(doc => ({
          id: doc.id, 
          ...doc.data()
        }));
        dataHandler.onDataChanged(bookingsData);
      }, (error) => {
        console.error("Error listening to Firestore:", error);
      });
    }

    async function initApp() {
      await initializeFirebaseAndAuth();

      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({background_color: v}); }},
            { get: () => config.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({surface_color: v}); }},
            { get: () => config.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({text_color: v}); }},
            { get: () => config.primary_action_color, set: (v) => { config.primary_action_color = v; window.elementSdk.setConfig({primary_action_color: v}); }},
            { get: () => config.secondary_action_color, set: (v) => { config.secondary_action_color = v; window.elementSdk.setConfig({secondary_action_color: v}); }}
          ],
          fontEditable: { get: () => config.font_family, set: (v) => { config.font_family = v; window.elementSdk.setConfig({font_family: v}); }},
          fontSizeable: { get: () => config.font_size, set: (v) => { config.font_size = v; window.elementSdk.setConfig({font_size: v}); }}
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title],
          ["billiard_enabled", config.billiard_enabled !== "false"],
          ["karaoke_enabled", config.karaoke_enabled !== "false"],
          ["massage_enabled", config.massage_enabled !== "false"],
          ["billiard_price", config.billiard_price],
          ["billiard_service", config.billiard_service],
          ["massage_price", config.massage_price],
          ["massage_service", config.massage_service],
          ["karaoke_k1_price", config.karaoke_k1_price],
          ["karaoke_k1_service", config.karaoke_k1_service],
          ["karaoke_k2_price", config.karaoke_k2_price],
          ["karaoke_k2_service", config.karaoke_k2_service],
          ["karaoke_k3_price", config.karaoke_k3_price],
          ["karaoke_k3_service", config.karaoke_k3_service]
        ])
      });
      
      renderApp();
    }

    function getRoomDetails(room) {
      const config = window.elementSdk?.config || defaultConfig;
      const { id } = room; 

      let price = 0;
      let service = 0;

      switch (id) {
        case 'B1': price = parseInt(config.billiard_price) || 0; service = parseInt(config.billiard_service) || 0; break;
        case 'M1': price = parseInt(config.massage_price) || 0; service = parseInt(config.massage_service) || 0; break;
        case 'K1': price = parseInt(config.karaoke_k1_price) || 0; service = parseInt(config.karaoke_k1_service) || 0; break;
        case 'K2': price = parseInt(config.karaoke_k2_price) || 0; service = parseInt(config.karaoke_k2_service) || 0; break;
        case 'K3': price = parseInt(config.karaoke_k3_price) || 0; service = parseInt(config.karaoke_k3_service) || 0; break;
        default: price = 0; service = 0;
      }
      return { price_per_hour: price, service_charge: service };
    }
    
    function isServiceEnabled(roomType) {
      const config = window.elementSdk?.config || defaultConfig;
      if (roomType === 'billiard') return config.billiard_enabled !== "false";
      if (roomType === 'karaoke') return config.karaoke_enabled !== "false";
      if (roomType === 'massage') return config.massage_enabled !== "false";
      return false;
    }
    
    function toggleServiceStatus(serviceType) {
      const config = window.elementSdk?.config || defaultConfig;
      const key = `${serviceType}_enabled`;
      const currentValue = config[key] !== "false";
      const newValue = !currentValue;
      window.elementSdk.setConfig({ [key]: newValue.toString() });
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function isDateInThisWeek(date) {
      const today = new Date();
      const firstDayOfWeek = new Date(today);
      const day = today.getDay(); 
      const diff = today.getDate() - day + (day === 0 ? -6 : 1); 
      firstDayOfWeek.setDate(diff);
      firstDayOfWeek.setHours(0, 0, 0, 0);

      const lastDayOfWeek = new Date(firstDayOfWeek);
      lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);
      lastDayOfWeek.setHours(23, 59, 59, 999);

      return date >= firstDayOfWeek && date <= lastDayOfWeek;
    }

    function isDateInThisMonth(date) {
      const today = new Date();
      return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
    }
    
    function generateExcelReport(reportType) {
      const completedBookings = allBookings.filter(b => 
        b.status === 'completed' && b.created_at
      );

      let filteredBookings;
      let fileName = "Laporan_Pendapatan.xlsx";

      if (reportType === 'weekly') {
        filteredBookings = completedBookings.filter(b => isDateInThisWeek(new Date(b.created_at)));
        fileName = `Laporan_Mingguan_${formatDate(new Date()).replace(/\//g, '-')}.xlsx`;
      } else if (reportType === 'monthly') {
        filteredBookings = completedBookings.filter(b => isDateInThisMonth(new Date(b.created_at)));
        fileName = `Laporan_Bulanan_${new Date().getMonth() + 1}_${new Date().getFullYear()}.xlsx`;
      } else {
        return;
      }

      if (filteredBookings.length === 0) {
        alert("Tidak ada data pendapatan yang selesai (completed) untuk periode ini.");
        return;
      }

      const dataForExcel = filteredBookings.map(b => ({
        "Tanggal": formatDate(b.created_at),
        "Waktu": formatTime(b.created_at),
        "Kasir": b.created_by,
        "Pelanggan": b.customer_name,
        "Ruangan": `${b.room_number} (${b.room_type})`,
        "Durasi (Jam)": b.duration_hours,
        "Biaya Sewa": (b.price_per_hour * b.duration_hours),
        "Biaya Service": b.service_charge,
        "Total Pendapatan": b.total_price
      }));

      const totalRevenue = dataForExcel.reduce((sum, row) => sum + row["Total Pendapatan"], 0);
      const ws = XLSX.utils.json_to_sheet(dataForExcel);
      
      XLSX.utils.sheet_add_aoa(ws, [
        [], 
        ["", "", "", "", "", "", "", "GRAND TOTAL", totalRevenue]
      ], { origin: -1 }); 

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Pendapatan");
      XLSX.writeFile(wb, fileName);
    }
    
    function playNotificationSound() {
      if (!audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.error("AudioContext tidak didukung.", e);
          return;
        }
      }

      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.type = 'sine'; 
      oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
      gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime); 

      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.3); 
    }
    
    function startRoomTimer() {
      stopRoomTimer();
      roomTimerInterval = setInterval(updateRoomTimers, 1000);
      playedSounds = {}; 
    }

    function stopRoomTimer() {
      if (roomTimerInterval) {
        clearInterval(roomTimerInterval);
        roomTimerInterval = null;
      }
    }
    
    function updateRoomTimers() {
      const timerDisplays = document.querySelectorAll('.room-timer-display');
      if (timerDisplays.length === 0) return; 

      const now = new Date();
      
      timerDisplays.forEach(display => {
        const endTimeStr = display.dataset.endTime;
        const roomId = display.dataset.roomId; 
        if (!endTimeStr) return;
        
        const end = new Date(endTimeStr);
        const diff = end - now;
        
        const card = display.closest('.room-card'); 
        
        if (diff <= 0) {
          display.textContent = 'Waktu Habis!';
          if (card && !card.classList.contains('expired-room')) {
            card.classList.add('expired-room');
            card.classList.remove('active-room'); 
            
            if (!playedSounds[roomId]) {
              playNotificationSound();
              playedSounds[roomId] = true; 
            }
          }
        } else {
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);
          
          display.textContent = `‚è≥ Sisa: ${hours}j ${minutes}m ${seconds}s`;
          if (card) {
            card.classList.remove('expired-room');
            card.classList.add('active-room');
          }
        }
      });
    }

    function getRoomStatus(roomId) {
      const activeBooking = allBookings.find(b => 
        b.room_number === roomId && b.status === 'active'
      );
      return activeBooking || null;
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      const user = USERS[username];
      if (user && user.password === password) {
        currentUser = user;
        currentView = 'dashboard';
        renderApp();
        startRoomTimer(); 
      } else {
        const errorDiv = document.getElementById('login-error');
        errorDiv.textContent = 'Username atau password salah!';
        errorDiv.classList.remove('hidden');
      }
    }

    function handleLogout() {
      currentUser = null;
      currentView = 'login';
      stopRoomTimer(); 
      renderApp();
    }

    function showBookingForm(room) {
      selectedBooking = { room, mode: 'new' };
      currentView = 'booking-form';
      stopRoomTimer(); 
      renderApp();
    }

    async function handleBookingSubmit(e) {
      e.preventDefault();
      
      if (!userId) {
        alert("Error: User tidak terautentikasi. Coba muat ulang.");
        return;
      }

      const customerName = document.getElementById('customer-name').value;
      const duration = parseInt(document.getElementById('duration').value);
      const bookingType = document.getElementById('booking-type').value;
      
      const now = new Date();
      let startTime;
      if (bookingType === 'open') {
        startTime = now;
      } else {
        const bookingTimeValue = document.getElementById('booking-time').value;
        if (!bookingTimeValue) {
            alert('Silakan pilih waktu mulai booking.');
            return;
        }
        startTime = new Date(bookingTimeValue);
      }
      
      const endTime = new Date(startTime.getTime() + duration * 60 * 60 * 1000);
      
      const { price_per_hour, service_charge } = getRoomDetails(selectedBooking.room);
      const totalPrice = (price_per_hour * duration) + service_charge;
      
      const booking = {
        room_type: selectedBooking.room.type,
        room_number: selectedBooking.room.id,
        customer_name: customerName,
        start_time: startTime.toISOString(),
        duration_hours: duration,
        end_time: endTime.toISOString(),
        status: bookingType === 'open' ? 'active' : 'booked',
        price_per_hour: price_per_hour, 
        service_charge: service_charge, 
        total_price: totalPrice, 
        created_by: currentUser.name,
        created_at: now.toISOString()
      };
      
      const submitBtn = document.getElementById('submit-booking');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Menyimpan...';
      
      const collectionRef = collection(db, 'payboss_bookings', appId, 'all_bookings');
      
      try {
        await addDoc(collectionRef, booking); 
        currentView = 'dashboard';
        renderApp();
        startRoomTimer(); 

      } catch (error) {
        console.error("Error adding document: ", error);
        alert('Gagal menyimpan booking. Silakan coba lagi.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan Booking';
      }
    }

    async function handleCheckout(booking) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 slide-in';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <h3 class="text-xl font-bold mb-4" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">Konfirmasi Checkout</h3>
          <p class="mb-4">Checkout untuk ${booking.customer_name}?</p>
          <p class="mb-6 font-bold text-lg">Total: ${formatCurrency(booking.total_price)}</p>
          <div class="flex gap-3">
            <button id="confirm-checkout" class="flex-1 px-4 py-2 rounded-lg text-white font-semibold" style="background-color: ${window.elementSdk?.config?.primary_action_color || defaultConfig.primary_action_color}">
              Ya, Checkout
            </button>
            <button id="cancel-checkout" class="flex-1 px-4 py-2 rounded-lg font-semibold" style="background-color: ${window.elementSdk?.config?.secondary_action_color || defaultConfig.secondary_action_color}; color: white;">
              Batal
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-checkout').onclick = async () => {
        if (!userId || !booking.id) {
           alert("Error: Tidak dapat checkout. User ID or Booking ID tidak ditemukan.");
           return;
        }

        const docRef = doc(db, 'payboss_bookings', appId, 'all_bookings', booking.id);
        
        try {
          await updateDoc(docRef, {
            status: 'completed'
          });
          
          document.body.removeChild(confirmDiv);
          
          const updatedBookingForReceipt = { ...booking, status: 'completed' };
          showReceipt(updatedBookingForReceipt);

        } catch (error) {
          console.error("Error updating document: ", error);
          alert("Gagal melakukan checkout. Coba lagi.");
          document.body.removeChild(confirmDiv);
        }
      };
      
      document.getElementById('cancel-checkout').onclick = () => {
        document.body.removeChild(confirmDiv);
      };
    }

    function handleCancelBooking() {
      currentView = 'dashboard';
      renderApp();
      startRoomTimer(); 
    }

    // ============================================
    // FUNGSI BARU: PRINT VIA RAWBT (BLUETOOTH)
    // ============================================
    function printViaRawBT(booking) {
        const receiptWidth = 32; 
        const pad = (str, len, char = ' ') => String(str).padEnd(len, char);
        const padLeft = (str, len, char = ' ') => String(str).padStart(len, char);
        
        let receiptText = '';

        receiptText += "         PAY BOSS CAFE\n";
        receiptText += " Jl. Tanjung Permai No 2 RT 07\n";
        receiptText += "    Pembataan.Murung Pudak.\n";
        receiptText += "            Tabalong\n";
        receiptText += "    Reservasi: 0811-5194-456\n";
        receiptText += "--------------------------------\n";
        
        receiptText += `Pelanggan: ${booking.customer_name}\n`;
        receiptText += `Kasir    : ${booking.created_by}\n`;
        receiptText += `Waktu    : ${formatDate(booking.created_at)}\n`;
        receiptText += "--------------------------------\n";

        // Item Ruangan
        let itemName = `${booking.room_number} - ${booking.room_type.toUpperCase()} (${booking.duration_hours} Jam)`;
        if (itemName.length > receiptWidth) {
            receiptText += pad(itemName.substring(0, receiptWidth), receiptWidth) + "\n";
            receiptText += pad("  " + itemName.substring(receiptWidth), receiptWidth) + "\n";
        } else {
            receiptText += pad(itemName, receiptWidth) + "\n";
        }
        
        const roomPriceTotal = booking.price_per_hour * booking.duration_hours;
        receiptText += padLeft(formatCurrency(roomPriceTotal), receiptWidth) + "\n";

        // Biaya Service (Jika ada)
        if (booking.service_charge > 0) {
             receiptText += pad("Biaya Service", 18) + padLeft(formatCurrency(booking.service_charge), 14) + "\n";
        }

        receiptText += "--------------------------------\n";

        // Total
        receiptText += pad("TOTAL", 12) + padLeft(formatCurrency(booking.total_price), 20) + "\n";
        receiptText += "--------------------------------\n";

        receiptText += "      Wifi : Pay Boss Cafe\n";
        receiptText += "     Pasword : P4yB0sSC4F3\n";
        receiptText += "--------------------------------\n";
        receiptText += "Terimakasih atas kunjungan anda.\n";
        receiptText += "    Instagram: @Payboss.cafe\n";
        receiptText += "\n\n\n"; 

        // Encode dan Buka RawBT
        const encodedReceiptText = encodeURIComponent(receiptText);
        const rawBtUrl = `rawbt:${encodedReceiptText}`;
        window.open(rawBtUrl, '_blank');
    }

    function showReceipt(booking) {
      const receiptDiv = document.createElement('div');
      receiptDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 slide-in';
      
      const receiptContent = `
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
          <div id="receipt-print" class="bg-white p-6">
            <div class="text-center mb-4">
              <h2 class="text-xl font-bold">PAY BOSS CAFE</h2>
              <p class="text-sm">Jl. Tanjung Permai No 2 RT 07 Pembataan</p>
              <p class="text-sm">Murung Pudak. Tabalong</p>
              <p class="text-sm">HP : 0811-5194-456</p>
            </div>
            
            <div class="border-t border-b border-gray-300 py-3 my-3 text-sm">
              <div class="flex justify-between mb-1">
                <span>Tanggal:</span>
                <span>${formatDate(booking.created_at)}</span>
              </div>
              <div class="flex justify-between mb-1">
                <span>Kasir:</span>
                <span>${booking.created_by}</span>
              </div>
              <div class="flex justify-between mb-1">
                <span>Pelanggan:</span>
                <span>${booking.customer_name}</span>
              </div>
            </div>
            
            <div class="mb-3 text-sm">
              <div class="flex justify-between mb-1">
                <span>${booking.room_number} - ${booking.room_type.toUpperCase()}</span>
                <span></span>
              </div>
              <div class="flex justify-between mb-1">
                <span>Sewa Ruangan (${booking.duration_hours} jam)</span>
                <span>${formatCurrency(booking.price_per_hour * booking.duration_hours)}</span>
              </div>
              ${booking.service_charge > 0 ? `
              <div class="flex justify-between mb-1">
                <span>Biaya Service</span>
                <span>${formatCurrency(booking.service_charge)}</span>
              </div>
              ` : ''}
            </div>
            
            <div class="border-t border-gray-300 pt-3 mb-4">
              <div class="flex justify-between font-bold text-lg">
                <span>TOTAL:</span>
                <span>${formatCurrency(booking.total_price)}</span>
              </div>
            </div>
            
            <div class="text-center text-sm border-t border-gray-300 pt-3">
              <p class="font-semibold mb-2">Instagram PAY BOSS CAFE</p>
              <p class="mb-1">Terimakasih atas kunjungan anda.</p>
              <p class="mb-1">Instagram : @Payboss.cafe</p>
              <p class="mb-1">Wifi : Pay Boss Cafe</p>
              <p>Password : P4yB0sSC4F3</p>
            </div>
          </div>
          
          <div class="flex gap-3 mt-4">
            <button id="print-receipt" class="flex-1 px-4 py-2 rounded-lg text-white font-semibold" style="background-color: ${window.elementSdk?.config?.primary_action_color || defaultConfig.primary_action_color}">
              üñ®Ô∏è Cetak Struk (Bluetooth)
            </button>
            <button id="close-receipt" class="flex-1 px-4 py-2 rounded-lg font-semibold" style="background-color: ${window.elementSdk?.config?.secondary_action_color || defaultConfig.secondary_action_color}; color: white;">
              Tutup
            </button>
          </div>
        </div>
      `;
      
      receiptDiv.innerHTML = receiptContent;
      document.body.appendChild(receiptDiv);
      
      // Event Listener Tombol Cetak
      document.getElementById('print-receipt').onclick = () => {
        printViaRawBT(booking);
      };
      
      document.getElementById('close-receipt').onclick = () => {
        document.body.removeChild(receiptDiv);
      };
    }

    function renderLogin() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;
      
      if (!userId) {
        return `<div class="p-4 text-center" style="color: ${config.text_color};">Menghubungkan ke server...</div>`;
      }

      return `
        <div class="min-h-screen flex w-full" style="background-color: ${config.background_color}; font-family: '${customFont}', ${baseFontStack};">
          
          <!-- SISI KIRI: GAMBAR (Split Screen Vertical/Portrait) -->
          <!-- Diubah flex-col menjadi flex-row agar gambar berdampingan kiri-kanan -->
          <div class="hidden lg:flex lg:w-1/2 flex-row relative">
            
            <!-- Bagian Kiri: Billiard (Portrait Strip) -->
            <!-- Diubah h-1/2 menjadi h-full w-1/2 -->
            <div class="h-full w-1/2 relative overflow-hidden group">
               <img src="https://i.imgur.com/jR2XAQZ.png" alt="Billiard Area" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
               <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                  <h2 class="text-4xl font-bold text-white tracking-widest shadow-lg text-center transform -rotate-90 whitespace-nowrap" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">BILLIARD</h2>
               </div>
            </div>
            
            <!-- Bagian Kanan: Karaoke (Portrait Strip) -->
            <!-- Diubah h-1/2 menjadi h-full w-1/2 -->
            <div class="h-full w-1/2 relative overflow-hidden group">
               <img src="https://i.imgur.com/HiF3Ln2.png" alt="Karaoke Room" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
               <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                  <h2 class="text-4xl font-bold text-white tracking-widest shadow-lg text-center transform rotate-90 whitespace-nowrap" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">KARAOKE VIP</h2>
               </div>
            </div>
          </div>

          <!-- SISI KANAN: FORM LOGIN -->
          <div class="w-full lg:w-1/2 flex items-center justify-center p-8 relative">
             <!-- Form Container -->
             <div class="w-full max-w-md p-8 rounded-2xl shadow-xl slide-in" style="background-color: ${config.surface_color};">
                <div class="text-center mb-8">
                  <h1 class="text-3xl font-bold mb-2" style="color: ${config.text_color}; font-size: ${baseSize * 2}px;">${config.app_title}</h1>
                  <p class="text-lg" style="color: ${config.text_color}; font-size: ${baseSize}px;">Login Staff</p>
                </div>
                
                <form onsubmit="handleLogin(event)" class="space-y-4">
                  <div>
                    <label for="username" class="block mb-2 font-semibold" style="color: ${config.text_color}; font-size: ${baseSize}px;">Username</label>
                    <input type="text" id="username" required class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none focus:ring-2" style="border-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                  </div>
                  
                  <div>
                    <label for="password" class="block mb-2 font-semibold" style="color: ${config.text_color}; font-size: ${baseSize}px;">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none focus:ring-2" style="border-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                  </div>
                  
                  <div id="login-error" class="hidden text-red-600 text-center font-semibold" style="font-size: ${baseSize * 0.9}px;"></div>
                  
                  <button type="submit" class="w-full py-3 rounded-lg text-white font-bold text-lg transition-transform hover:scale-105" style="background-color: ${config.primary_action_color}; font-size: ${baseSize * 1.1}px;">
                    üîê Masuk Aplikasi
                  </button>
                </form>
             </div>
             
             <div class="absolute bottom-4 text-sm opacity-50" style="color: ${config.text_color}">
                &copy; 2025 Pay Boss Entertainment System
             </div>
          </div>

        </div>
      `;
    }

    function getDailySalesAnalysis() {
      const today = new Date();
      const todayStr = today.toDateString();
      
      const todayBookings = allBookings.filter(booking => {
        const bookingDateStr = booking.created_at || booking.start_time;
        if (!bookingDateStr) return false;
        
        const bookingDate = new Date(bookingDateStr);
        return bookingDate.toDateString() === todayStr && booking.status === 'completed';
      });
      
      const totalRevenue = todayBookings.reduce((sum, booking) => sum + booking.total_price, 0);
      
      const categoryStats = {
        billiard: { count: 0, revenue: 0, hours: 0 },
        karaoke: { count: 0, revenue: 0, hours: 0 },
        massage: { count: 0, revenue: 0, hours: 0 }
      };
      
      todayBookings.forEach(booking => {
        const category = booking.room_type;
        if (categoryStats[category]) {
          categoryStats[category].count++;
          categoryStats[category].revenue += booking.total_price;
          categoryStats[category].hours += booking.duration_hours;
        }
      });
      
      const activeBookings = allBookings.filter(booking => booking.status === 'active');
      const pendingRevenue = activeBookings.reduce((sum, booking) => sum + booking.total_price, 0);
      
      const cashierStats = {};
      todayBookings.forEach(booking => {
        if (!booking.created_by) return;
        if (!cashierStats[booking.created_by]) {
          cashierStats[booking.created_by] = { count: 0, revenue: 0 };
        }
        cashierStats[booking.created_by].count++;
        cashierStats[booking.created_by].revenue += booking.total_price;
      });
      
      const topCashier = Object.entries(cashierStats).sort((a, b) => b[1].revenue - a[1].revenue)[0];
      
      return {
        totalRevenue,
        totalBookings: todayBookings.length,
        categoryStats,
        activeBookings: activeBookings.length,
        pendingRevenue,
        topCashier: topCashier ? { name: topCashier[0], ...topCashier[1] } : null
      };
    }

    function renderDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;
      
      const allRoomsRaw = [...ROOMS.billiard, ...ROOMS.karaoke, ...ROOMS.massage];
      const allRooms = allRoomsRaw.filter(room => isServiceEnabled(room.type));
      
      const salesAnalysis = getDailySalesAnalysis();
      
      const salesAnalysisSection = currentUser.role === 'Manager' ? `
        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="p-4 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">üí∞ Pendapatan Hari Ini</p>
                <p class="text-2xl font-bold" style="color: ${config.primary_action_color}; font-size: ${baseSize * 1.5}px;">${formatCurrency(salesAnalysis.totalRevenue)}</p>
                <p class="text-xs" style="color: ${config.text_color}; font-size: ${baseSize * 0.75}px;">${salesAnalysis.totalBookings} transaksi selesai</p>
              </div>
              <div class="text-3xl">üìä</div>
            </div>
          </div>
          
          <div class="p-4 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">üîÑ Booking Aktif</p>
                <p class="text-2xl font-bold" style="color: ${config.secondary_action_color}; font-size: ${baseSize * 1.5}px;">${salesAnalysis.activeBookings}</p>
                <p class="text-xs" style="color: ${config.text_color}; font-size: ${baseSize * 0.75}px;">Pending: ${formatCurrency(salesAnalysis.pendingRevenue)}</p>
              </div>
              <div class="text-3xl">‚è≥</div>
            </div>
          </div>
          
          <div class="p-4 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">üèÜ Terpopuler</p>
                ${Object.entries(salesAnalysis.categoryStats).sort((a, b) => b[1].count - a[1].count).slice(0, 1).map(([type, stats]) => `
                  <p class="text-lg font-bold capitalize" style="color: ${config.text_color}; font-size: ${baseSize * 1.1}px;">${type}</p>
                  <p class="text-xs" style="color: ${config.text_color}; font-size: ${baseSize * 0.75}px;">${stats.count} booking, ${stats.hours}h</p>
                `).join('')}
              </div>
              <div class="text-3xl">üéØ</div>
            </div>
          </div>
          
          <div class="p-4 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-medium" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">üëë Kasir Terbaik</p>
                ${salesAnalysis.topCashier ? `
                  <p class="text-lg font-bold" style="color: ${config.text_color}; font-size: ${baseSize * 1.1}px;">${salesAnalysis.topCashier.name}</p>
                  <p class="text-xs" style="color: ${config.text_color}; font-size: ${baseSize * 0.75}px;">${formatCurrency(salesAnalysis.topCashier.revenue)}</p>
                ` : `
                  <p class="text-lg" style="color: ${config.text_color}; font-size: ${baseSize * 1.1}px;">Belum ada</p>
                  <p class="text-xs" style="color: ${config.text_color}; font-size: ${baseSize * 0.75}px;">transaksi hari ini</p>
                `}
              </div>
              <div class="text-3xl">ü•á</div>
            </div>
          </div>
        </div>
        
        <div class="mb-6 p-6 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
          <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}; font-size: ${baseSize * 1.25}px;">üìà Analisa Penjualan per Kategori</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${Object.entries(salesAnalysis.categoryStats).map(([type, stats]) => `
              <div class="p-4 rounded-lg border-2" style="background-color: ${config.background_color}; border-color: ${config.secondary_action_color};">
                <h4 class="font-bold capitalize mb-2" style="color: ${config.text_color}; font-size: ${baseSize * 1.1}px;">
                  ${type === 'billiard' ? 'üé±' : type === 'karaoke' ? 'üé§' : 'üíÜ'} ${type}
                </h4>
                <div class="space-y-1">
                  <p class="text-sm" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">
                    <span class="font-semibold">Booking:</span> ${stats.count}x
                  </p>
                  <p class="text-sm" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">
                    <span class="font-semibold">Total Jam:</span> ${stats.hours}h
                  </p>
                  <p class="text-sm" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">
                    <span class="font-semibold">Pendapatan:</span> ${formatCurrency(stats.revenue)}
                  </p>
                  <p class="text-xs" style="color: ${config.text_color}; font-size: ${baseSize * 0.75}px;">
                    Rata-rata: ${stats.count > 0 ? formatCurrency(stats.revenue / stats.count) : formatCurrency(0)}/booking
                  </p>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : '';
      
      const managerControlsSection = currentUser.role === 'Manager' ? `
        <div class="mb-6 p-6 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
          <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}; font-size: ${baseSize * 1.25}px;">‚öôÔ∏è Kontrol Layanan</h3>
          <p class="text-sm mb-4" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">
            (Perubahan ini hanya untuk sesi ini. Muat ulang akan mengembalikan ke setelan 'defaultConfig' di kode.)
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${['billiard', 'karaoke', 'massage'].map(type => {
              const enabled = isServiceEnabled(type);
              return `
              <div class="p-4 rounded-lg border-2 ${enabled ? 'border-green-400' : 'border-red-400'}" style="background-color: ${config.background_color};">
                <h4 class="font-bold capitalize mb-2" style="color: ${config.text_color}; font-size: ${baseSize * 1.1}px;">
                  ${type === 'billiard' ? 'üé±' : type === 'karaoke' ? 'üé§' : 'üíÜ'} ${type}
                </h4>
                <button onclick="toggleServiceStatus('${type}')" class="w-full py-2 rounded-lg text-white font-semibold" style="background-color: ${enabled ? config.secondary_action_color : '#10B981'};">
                  ${enabled ? 'NONAKTIFKAN' : 'AKTIFKAN'}
                </button>
                ${!enabled ? `<p class="text-xs text-center mt-2 p-1 bg-yellow-100 text-yellow-800 rounded" style="font-size: ${baseSize * 0.75}px;">Layanan Ditutup</p>` : ''}
              </div>
              `}).join('')}
          </div>
        </div>
      ` : '';
      
      const managerReportsSection = currentUser.role === 'Manager' ? `
        <div class="mb-6 p-6 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
          <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}; font-size: ${baseSize * 1.25}px;">üìÑ Laporan Pendapatan</h3>
          <p class="text-sm mb-4" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">
            Download laporan pendapatan (hanya dari transaksi 'completed') dalam format Excel.
          </p>
          <div class="flex flex-col sm:flex-row gap-4">
            <button onclick="generateExcelReport('weekly')" class="flex-1 py-3 px-4 rounded-lg text-white font-semibold transition-transform hover:scale-105" style="background-color: ${config.primary_action_color}; font-size: ${baseSize}px;">
              üíæ Download Laporan Minggu Ini
            </button>
            <button onclick="generateExcelReport('monthly')" class="flex-1 py-3 px-4 rounded-lg text-white font-semibold transition-transform hover:scale-105" style="background-color: ${config.primary_action_color}; font-size: ${baseSize}px;">
              üíæ Download Laporan Bulan Ini
            </button>
          </div>
        </div>
      ` : '';
      
      const roomCards = allRooms.map(room => {
        const status = getRoomStatus(room.id);
        const isActive = status !== null;
        
        const { price_per_hour, service_charge } = getRoomDetails(room);
        
        return `
          <div class="room-card p-6 rounded-xl shadow-lg transition-transform hover:scale-105 ${isActive ? 'active-room' : ''}" style="background-color: ${config.surface_color};">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-bold mb-1" style="color: ${config.text_color}; font-size: ${baseSize * 1.25}px;">${room.name}</h3>
                
                <p class="text-sm" style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;">
                  ${formatCurrency(price_per_hour)}/jam
                  ${service_charge > 0 ? ` (+${formatCurrency(service_charge)} service)` : ''}
                </p>
                
              </div>
              <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background-color: ${isActive ? '#EF4444' : '#10B981'}; color: white; font-size: ${baseSize * 0.85}px;">
                ${isActive ? 'üî¥ Aktif' : 'üü¢ Tersedia'}
              </span>
            </div>
            
            ${isActive ? `
              <div class="mb-4 p-3 rounded-lg" style="background-color: ${config.background_color};">
                <p class="font-semibold mb-1" style="color: ${config.text_color}; font-size: ${baseSize * 0.9}px;">üë§ ${status.customer_name}</p>
                <p class="text-sm mb-1" style="color: ${config.text_color}; font-size: ${baseSize * 0.8}px;">‚è∞ Masuk: ${formatTime(status.start_time)}</p>
                <p class="text-sm mb-1" style="color: ${config.text_color}; font-size: ${baseSize * 0.8}px;">üèÅ Keluar: ${formatTime(status.end_time)}</p>
                
                <p class="room-timer-display text-sm font-bold" 
                   style="color: ${config.text_color}; font-size: ${baseSize * 0.85}px;"
                   data-end-time="${status.end_time}"
                   data-room-id="${status.id}">
                  ‚è≥ Sisa: Menghitung...
                </p>
                
              </div>
              <button onclick='handleCheckout(${JSON.stringify(status).replace(/"/g, "&quot;")})' class="w-full py-2 rounded-lg text-white font-semibold transition-transform hover:scale-105" style="background-color: ${config.primary_action_color}; font-size: ${baseSize}px;">
                üí∞ Checkout - ${formatCurrency(status.total_price)}
              </button>
            ` : `
              <button onclick='showBookingForm(${JSON.stringify(room)})' class="w-full py-2 rounded-lg text-white font-semibold transition-transform hover:scale-105" style="background-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                ‚ûï Booking Ruangan
              </button>
            `}
          </div>
        `;
      }).join('');
      
      return `
        <div style="background-color: ${config.background_color}; font-family: '${customFont}', ${baseFontStack}; min-height: 100%;">
          <div class="max-w-7xl mx-auto p-4">
            <div class="flex justify-between items-center mb-6 p-4 rounded-xl shadow-lg" style="background-color: ${config.surface_color};">
              <div>
                <h1 class="text-2xl font-bold" style="color: ${config.text_color}; font-size: ${baseSize * 1.5}px;">${config.app_title}</h1>
                <p style="color: ${config.text_color}; font-size: ${baseSize * 0.9}px;">üë§ ${currentUser.name} (${currentUser.role})</p>
              </div>
              <button onclick="handleLogout()" class="px-6 py-2 rounded-lg text-white font-semibold transition-transform hover:scale-105" style="background-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                üö™ Logout
              </button>
            </div>
            
            <!-- BANNER PROMOSI (BARU) -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="relative h-48 rounded-xl overflow-hidden shadow-lg group">
                   <img src="https://i.imgur.com/jR2XAQZ.png" alt="Billiard" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                   <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80 flex items-end p-4">
                      <h3 class="text-2xl font-bold text-white tracking-wider">BILLIARD AREA</h3>
                   </div>
                </div>
                
                <div class="relative h-48 rounded-xl overflow-hidden shadow-lg group">
                   <img src="https://i.imgur.com/HiF3Ln2.png" alt="Karaoke" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                   <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80 flex items-end p-4">
                      <h3 class="text-2xl font-bold text-white tracking-wider">KARAOKE VIP</h3>
                   </div>
                </div>
            </div>
            
            ${salesAnalysisSection}
            ${managerControlsSection} 
            ${managerReportsSection} 
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${roomCards}
            </div>
          </div>
        </div>
      `;
    }

    function renderBookingForm() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const baseSize = config.font_size || defaultConfig.font_size;
      
      const { price_per_hour, service_charge } = getRoomDetails(selectedBooking.room);
      
      return `
        <div style="background-color: ${config.background_color}; font-family: '${customFont}', ${baseFontStack}; min-height: 100%;">
          <div class="max-w-2xl mx-auto p-4">
            <div class="p-6 rounded-xl shadow-2xl slide-in" style="background-color: ${config.surface_color};">
              <h2 class="text-2xl font-bold mb-6" style="color: ${config.text_color}; font-size: ${baseSize * 1.5}px;">üìù Booking ${selectedBooking.room.name}</h2>
              
              <form onsubmit="handleBookingSubmit(event)" class="space-y-4">
                <div>
                  <label class="block mb-2 font-semibold" style="color: ${config.text_color}; font-size: ${baseSize}px;">Nama Pelanggan</label>
                  <input type="text" id="customer-name" required class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none focus:ring-2" style="border-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label class="block mb-2 font-semibold" style="color: ${config.text_color}; font-size: ${baseSize}px;">Tipe Booking</label>
                  <select id="booking-type" class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none focus:ring-2" style="border-color: ${config.secondary_action_color}; font-size: ${baseSize}px;" onchange="document.getElementById('booking-time-group').style.display = this.value === 'booking' ? 'block' : 'none'">
                    <option value="open">üü¢ Open Room (Mulai Sekarang)</option>
                    <option value="booking">üìÖ Booking (Jadwal Nanti)</option>
                  </select>
                </div>
                
                <div id="booking-time-group" style="display: none;">
                  <label class="block mb-2 font-semibold" style="color: ${config.text_color}; font-size: ${baseSize}px;">Waktu Mulai</label>
                  <input type="datetime-local" id="booking-time" class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none focus:ring-2" style="border-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                </div>
                
                <div>
                  <label class="block mb-2 font-semibold" style="color: ${config.text_color}; font-size: ${baseSize}px;">Durasi</label>
                  <select id="duration" class="w-full px-4 py-3 rounded-lg border-2 focus:outline-none focus:ring-2" style="border-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                    <option value="1">1 Jam - ${formatCurrency((price_per_hour * 1) + service_charge)}</option>
                    <option value="2">2 Jam - ${formatCurrency((price_per_hour * 2) + service_charge)}</option>
                    <option value="3">3 Jam - ${formatCurrency((price_per_hour * 3) + service_charge)}</option>
                  </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                  <button type="submit" id="submit-booking" class="flex-1 py-3 rounded-lg text-white font-bold transition-transform hover:scale-105" style="background-color: ${config.primary_action_color}; font-size: ${baseSize * 1.1}px;">
                    ‚úÖ Simpan Booking
                  </button>
                  <button type="button" onclick="handleCancelBooking()" class="flex-1 py-3 rounded-lg text-white font-semibold transition-transform hover:scale-105" style="background-color: ${config.secondary_action_color}; font-size: ${baseSize}px;">
                    ‚ùå Batal
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function renderApp() {
      const app = document.getElementById('app');
      if (!userId) {
        app.innerHTML = renderLogin(); 
        return;
      }
      if (currentView === 'login') {
        app.innerHTML = renderLogin();
      } else if (currentView === 'dashboard') {
        app.innerHTML = renderDashboard();
        updateRoomTimers(); 
      } else if (currentView === 'booking-form') {
        app.innerHTML = renderBookingForm();
      }
    }

    async function onConfigChange(config) {
      renderApp();
    }
    
    window.handleLogin = handleLogin;
    window.handleLogout = handleLogout;
    window.showBookingForm = showBookingForm;
    window.handleBookingSubmit = handleBookingSubmit;
    window.handleCheckout = handleCheckout;
    window.toggleServiceStatus = toggleServiceStatus; 
    window.handleCancelBooking = handleCancelBooking; 
    window.generateExcelReport = generateExcelReport; 

    initApp();
  </script>
</body>
</html>
